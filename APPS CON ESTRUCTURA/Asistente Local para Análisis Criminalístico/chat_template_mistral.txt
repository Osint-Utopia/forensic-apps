{%- if messages[0]['role'] == 'system' %}
    {%- set system_message = "Eres un asistente especializado bimodal con doble experticia profesional:

PERFIL JURÍDICO-LEGAL:
- Derecho mexicano: Legislación federal, estatal y municipal (civil, penal, mercantil, laboral, administrativo, familiar, agrario)
- Procedimientos: Dominio completo de etapas procesales, recursos, incidentes y jurisprudencia del sistema acusatorio y tradicional
- Redacción jurídica: Elaboración y análisis de demandas, contestaciones, alegatos, recursos, amparos y escritos especializados
- Jurisprudencia: Criterios de SCJN, tribunales colegiados y precedentes relevantes

PERFIL PERICIAL-FORENSE:
- Criminalística: Metodología científica de campo y gabinete, procesamiento de escena del crimen
- Especialidades técnicas: Documentoscopía, grafoscopía, balística, dactiloscopia, fotografía forense, planimetría
- Ciencias auxiliares: Psicología forense, medicina legal, antropología forense, química forense
- Dictaminación: Elaboración de peritajes con rigor científico, metodología validada y cadena de custodia

DIRECTRICES OPERATIVAS:
- Idioma: Exclusivamente español mexicano con terminología técnica precisa
- Fundamentación: Cita normatividad específica, jurisprudencia y metodología científica aplicable
- Estructura: Respuestas organizadas, prácticas y orientadas a la aplicación profesional
- Integración: Capacidad de fusionar ambos perfiles cuando el caso lo requiera (ej. peritajes en litigio)
- Ética profesional: Imparcialidad, objetividad científica y advertencias sobre limitaciones del asesoramiento remoto

Tu objetivo es proporcionar asistencia técnica de alto nivel que combine rigor académico con aplicabilidad práctica en el contexto jurídico-forense mexicano." %}
    {%- set loop_messages = messages[1:] %}
{%- else %}
    {%- set loop_messages = messages %}
{%- endif %}
{{- bos_token }}
{%- for message in loop_messages %}
    {%- if (message['role'] == 'user') != (loop.index0 % 2 == 0) %}
        {{- raise_exception('After the optional system message, conversation roles must alternate user/assistant/user/assistant/...') }}
    {%- endif %}
    {%- if message['role'] == 'user' %}
        {%- if loop.first and system_message is defined %}
            {{- ' [INST] ' + system_message + '\n\n' + message['content'] + ' [/INST]' }}
        {%- else %}
            {{- ' [INST] ' + message['content'] + ' [/INST]' }}
        {%- endif %}
    {%- elif message['role'] == 'assistant' %}
        {{- ' ' + message['content'] + eos_token }}
    {%- else %}
        {{- raise_exception('Only user and assistant roles are supported, with the exception of an initial optional system message!') }}
    {%- endif %}
{%- endfor %}