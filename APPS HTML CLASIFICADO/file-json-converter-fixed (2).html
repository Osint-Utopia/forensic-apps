<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversor a JSON Dataset</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #0d1117;
            --color-panel: rgba(255,255,255,0.06);
            --color-accent: #00ffff;
            --color-text: #e6e6e6;
            --color-success: #00d26a;
            --color-warning: #f5b70a;
            --color-error: #ff3c3c;
            --blur: 20px;
            --radius: 10px;
            --transition: 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: var(--color-panel);
            backdrop-filter: blur(var(--blur));
            padding: 30px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(0,255,255,0.2);
        }

        .header h1 {
            font-size: 2em;
            color: var(--color-accent);
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.8;
        }

        .card {
            background: var(--color-panel);
            backdrop-filter: blur(var(--blur));
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(0,255,255,0.2);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,255,255,0.15);
        }

        .card h2 {
            color: var(--color-accent);
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .upload-area {
            border: 2px dashed rgba(0,255,255,0.4);
            border-radius: var(--radius);
            padding: 40px;
            text-align: center;
            background: rgba(0,255,255,0.03);
            cursor: pointer;
            transition: var(--transition);
        }

        .upload-area:hover {
            background: rgba(0,255,255,0.08);
            border-color: var(--color-accent);
        }

        .upload-area.dragover {
            background: rgba(0,255,255,0.15);
            border-color: var(--color-accent);
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: var(--color-accent);
            color: #0d1117;
            border: none;
            padding: 12px 30px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
            margin: 5px;
        }

        .btn:hover {
            background: #00c4cc;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,255,255,0.4);
        }

        .btn-secondary {
            background: rgba(0,255,255,0.2);
            color: var(--color-accent);
            border: 1px solid var(--color-accent);
        }

        .btn-secondary:hover {
            background: rgba(0,255,255,0.3);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--color-text);
            font-weight: 600;
        }

        .input-group input[type="text"], 
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(0,255,255,0.3);
            background: rgba(0,255,255,0.05);
            color: var(--color-text);
            border-radius: var(--radius);
            font-size: 14px;
            transition: var(--transition);
        }

        .input-group input[type="text"]:focus, 
        .input-group select:focus {
            outline: none;
            border-color: var(--color-accent);
            background: rgba(0,255,255,0.1);
        }

        .input-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .output-area {
            background: #000000;
            color: #00ff00;
            padding: 20px;
            border-radius: var(--radius);
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid rgba(0,255,255,0.3);
        }

        .file-info {
            background: rgba(0,255,255,0.05);
            padding: 15px;
            border-radius: var(--radius);
            margin-top: 15px;
            display: none;
            border: 1px solid rgba(0,255,255,0.2);
        }

        .file-info.show {
            display: block;
        }

        .file-info p {
            margin: 5px 0;
        }

        .file-info strong {
            color: var(--color-accent);
        }

        .status {
            padding: 12px;
            border-radius: var(--radius);
            margin-top: 15px;
            text-align: center;
            font-weight: 600;
        }

        .status.success {
            background: rgba(0,210,106,0.2);
            color: var(--color-success);
            border: 1px solid var(--color-success);
        }

        .status.error {
            background: rgba(255,60,60,0.2);
            color: var(--color-error);
            border: 1px solid var(--color-error);
        }

        .status.info {
            background: rgba(0,255,255,0.2);
            color: var(--color-accent);
            border: 1px solid var(--color-accent);
        }

        .loader {
            border: 4px solid rgba(0,255,255,0.1);
            border-top: 4px solid var(--color-accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Conversor de Archivos a JSON</h1>
            <p>Convierte TXT, DOC, DOCX, PDF, CSV, XML a formato JSON limpio</p>
        </div>

        <!-- Carga de archivo -->
        <div class="card">
            <h2>1Ô∏è‚É£ Cargar Archivo</h2>
            <div class="upload-area" id="uploadArea">
                <p style="font-size: 48px; margin-bottom: 10px;">üìÅ</p>
                <p style="font-size: 18px; margin-bottom: 10px;">Arrastra y suelta tu archivo aqu√≠</p>
                <p style="opacity: 0.6; margin-bottom: 20px;">o haz clic para seleccionar</p>
                <button class="btn" onclick="document.getElementById('fileInput').click()">Seleccionar Archivo</button>
                <input type="file" id="fileInput" accept=".txt,.doc,.docx,.pdf,.csv,.xml,.json">
                <p style="opacity: 0.5; margin-top: 15px; font-size: 12px;">Formatos: TXT, DOC, DOCX, PDF, CSV, XML, JSON</p>
            </div>
            <div class="file-info" id="fileInfo"></div>
        </div>

        <!-- Opciones b√°sicas -->
        <div class="card">
            <h2>2Ô∏è‚É£ Opciones</h2>
            <div class="input-group">
                <label>
                    <input type="checkbox" id="translateOption">
                    Traducir del ingl√©s al espa√±ol
                </label>
            </div>
            <div class="input-group">
                <label>
                    <input type="checkbox" id="minimalJson" checked>
                    JSON m√≠nimo (sin metadatos extras)
                </label>
            </div>
        </div>

        <!-- Procesamiento -->
        <div class="card">
            <h2>3Ô∏è‚É£ Procesar</h2>
            <button class="btn" onclick="processFile()">üîÑ Convertir a JSON</button>
            <button class="btn btn-secondary" onclick="downloadJSON()">üíæ Descargar JSON</button>
            <button class="btn btn-secondary" onclick="clearAll()">üóëÔ∏è Limpiar</button>
            <div class="loader" id="loader"></div>
            <div id="status"></div>
        </div>

        <!-- Resultado -->
        <div class="card">
            <h2>4Ô∏è‚É£ Resultado JSON</h2>
            <div class="output-area" id="output">// El JSON aparecer√° aqu√≠ despu√©s de procesar...</div>
        </div>
    </div>

    <script>
        let currentFile = null;
        let jsonResult = null;

        // Configurar drag and drop
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            currentFile = file;
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `
                <p><strong>üìÑ Archivo:</strong> ${file.name}</p>
                <p><strong>üìè Tama√±o:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                <p><strong>üìã Tipo:</strong> ${file.type || 'Desconocido'}</p>
            `;
            fileInfo.classList.add('show');
            showStatus('Archivo cargado. Presiona "Convertir a JSON"', 'success');
        }

        async function processFile() {
            if (!currentFile) {
                showStatus('Por favor, selecciona un archivo primero', 'error');
                return;
            }

            showLoader(true);
            showStatus('Procesando archivo...', 'info');

            try {
                let content = await readFile(currentFile);
                
                // Traducir si se solicita
                if (document.getElementById('translateOption').checked) {
                    content = await translateToSpanish(content);
                }

                // Crear JSON estructurado
                jsonResult = createJSONDataset(content);
                
                // Mostrar resultado
                document.getElementById('output').textContent = JSON.stringify(jsonResult, null, 2);
                showStatus('‚úÖ Convertido exitosamente', 'success');
            } catch (error) {
                showStatus('‚ùå Error: ' + error.message, 'error');
                console.error(error);
            } finally {
                showLoader(false);
            }
        }

        async function readFile(file) {
            const extension = file.name.split('.').pop().toLowerCase();
            
            switch(extension) {
                case 'txt':
                    return await readAsText(file);
                case 'csv':
                    return await readCSV(file);
                case 'xml':
                    return await readXML(file);
                case 'json':
                    return await readJSON(file);
                case 'pdf':
                    return await readAsText(file);
                case 'doc':
                case 'docx':
                    return await readDOCX(file);
                default:
                    throw new Error('Formato no soportado: ' + extension);
            }
        }

        function readAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        async function readCSV(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => resolve(results.data),
                    error: reject
                });
            });
        }

        async function readXML(file) {
            const text = await readAsText(file);
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, "text/xml");
            return xmlToJson(xmlDoc);
        }

        function xmlToJson(xml) {
            let obj = {};
            if (xml.nodeType === 1) {
                if (xml.attributes.length > 0) {
                    obj["attributes"] = {};
                    for (let j = 0; j < xml.attributes.length; j++) {
                        const attribute = xml.attributes.item(j);
                        obj["attributes"][attribute.nodeName] = attribute.nodeValue;
                    }
                }
            } else if (xml.nodeType === 3) {
                obj = xml.nodeValue;
            }
            if (xml.hasChildNodes()) {
                for (let i = 0; i < xml.childNodes.length; i++) {
                    const item = xml.childNodes.item(i);
                    const nodeName = item.nodeName;
                    if (typeof obj[nodeName] === "undefined") {
                        obj[nodeName] = xmlToJson(item);
                    } else {
                        if (typeof obj[nodeName].push === "undefined") {
                            const old = obj[nodeName];
                            obj[nodeName] = [];
                            obj[nodeName].push(old);
                        }
                        obj[nodeName].push(xmlToJson(item));
                    }
                }
            }
            return obj;
        }

        async function readJSON(file) {
            const text = await readAsText(file);
            return JSON.parse(text);
        }

        async function readDOCX(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const arrayBuffer = e.target.result;
                        const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                        resolve(result.value);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function translateToSpanish(content) {
            showStatus('üåê Traduciendo al espa√±ol...', 'info');
            
            try {
                // Preparar el contenido para traducir
                let textToTranslate = '';
                let isObject = false;
                
                if (typeof content === 'string') {
                    textToTranslate = content;
                } else if (Array.isArray(content) || typeof content === 'object') {
                    textToTranslate = JSON.stringify(content, null, 2);
                    isObject = true;
                }

                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 8000,
                        messages: [
                            { 
                                role: "user", 
                                content: `Traduce COMPLETAMENTE del ingl√©s al espa√±ol el siguiente contenido.

REGLAS CR√çTICAS:
1. Traduce TODO el texto, no omitas nada
2. Si es JSON/Array, mant√©n la estructura EXACTA pero traduce los valores de texto
3. NO agregues explicaciones, comentarios ni texto adicional
4. NO uses bloques de c√≥digo markdown (\`\`\`json o \`\`\`)
5. Devuelve SOLO el contenido traducido puro
6. Si ya est√° en espa√±ol, devu√©lvelo sin cambios

Contenido:
${textToTranslate}`
                            }
                        ],
                    })
                });

                const data = await response.json();
                let translatedText = data.content
                    .map(item => (item.type === "text" ? item.text : ""))
                    .filter(Boolean)
                    .join("\n");
                
                // Limpieza agresiva de formato markdown y texto extra
                translatedText = translatedText
                    .replace(/```json\s*/g, '')
                    .replace(/```javascript\s*/g, '')
                    .replace(/```\s*/g, '')
                    .replace(/^.*?[{[]/s, function(match) {
                        // Encuentra el primer { o [ y elimina todo antes
                        const firstBracket = match.lastIndexOf('{');
                        const firstArray = match.lastIndexOf('[');
                        const start = Math.max(firstBracket, firstArray);
                        return match.substring(start);
                    })
                    .trim();
                
                // Si era objeto, intentar parsear
                if (isObject) {
                    try {
                        // Eliminar texto despu√©s del √∫ltimo } o ]
                        const lastBrace = translatedText.lastIndexOf('}');
                        const lastBracket = translatedText.lastIndexOf(']');
                        const end = Math.max(lastBrace, lastBracket);
                        if (end > -1) {
                            translatedText = translatedText.substring(0, end + 1);
                        }
                        
                        return JSON.parse(translatedText);
                    } catch (parseError) {
                        console.error('Error parseando JSON:', parseError);
                        // Si falla el parseo, devolver como texto
                        return translatedText;
                    }
                }
                
                return translatedText;
            } catch (error) {
                showStatus('‚ö†Ô∏è Error en traducci√≥n. Usando original.', 'info');
                console.error('Error en traducci√≥n:', error);
                return content;
            }
        }

        function createJSONDataset(content) {
            const minimalMode = document.getElementById('minimalJson').checked;
            
            if (minimalMode) {
                // JSON limpio sin metadatos
                return {
                    data: content
                };
            } else {
                // JSON con metadatos b√°sicos
                return {
                    filename: currentFile.name,
                    data: content
                };
            }
        }

        function downloadJSON() {
            if (!jsonResult) {
                showStatus('Primero debes procesar un archivo', 'error');
                return;
            }

            const dataStr = JSON.stringify(jsonResult, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const filename = currentFile.name.split('.')[0] + '.json';
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showStatus('üì• JSON descargado', 'success');
        }

        function clearAll() {
            currentFile = null;
            jsonResult = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').classList.remove('show');
            document.getElementById('output').textContent = '// El JSON aparecer√° aqu√≠ despu√©s de procesar...';
            document.getElementById('translateOption').checked = false;
            document.getElementById('status').innerHTML = '';
            showStatus('üîÑ Listo para nuevo archivo', 'info');
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>