<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Conversor a JSON Dataset</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root {
  --color-bg: #0d1117;
  --color-panel: rgba(255,255,255,0.06);
  --color-accent: #00ffff;
  --color-text: #e6e6e6;
  --color-success: #00d26a;
  --color-warning: #f5b70a;
  --color-error: #ff3c3c;
  --blur: 20px;
  --radius: 10px;
  --transition: 0.3s ease;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', sans-serif;
  background-color: var(--color-bg);
  color: var(--color-text);
  min-height: 100vh;
  display: flex;
}

/* SIDEBAR */
.sidebar {
  width: 230px;
  background: var(--color-panel);
  backdrop-filter: blur(var(--blur));
  display: flex;
  flex-direction: column;
  padding: 20px;
  border-right: 1px solid rgba(255,255,255,0.08);
}

.sidebar h1 {
  font-size: 1.3rem;
  color: var(--color-accent);
  text-align: center;
  margin-bottom: 20px;
}

.nav-item {
  padding: 12px 15px;
  margin-bottom: 6px;
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  cursor: pointer;
  transition: var(--transition);
}

.nav-item i {
  margin-right: 10px;
}

.nav-item:hover, .nav-item.active {
  background-color: rgba(0,255,255,0.15);
  color: var(--color-accent);
}

/* MAIN */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.topbar {
  background: var(--color-panel);
  backdrop-filter: blur(var(--blur));
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}

.topbar .title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.1rem;
  font-weight: 600;
}

.topbar .actions i {
  margin-left: 20px;
  cursor: pointer;
  transition: var(--transition);
}

.topbar .actions i:hover {
  color: var(--color-accent);
}

/* CONTENT */
.content {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

.section {
  background: var(--color-panel);
  backdrop-filter: blur(var(--blur));
  border-radius: var(--radius);
  padding: 25px;
  margin-bottom: 20px;
  border: 1px solid rgba(0,255,255,0.2);
  transition: var(--transition);
}

.section:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,255,255,0.15);
}

.section h2 {
  color: var(--color-accent);
  margin-bottom: 20px;
  font-size: 1.3em;
  display: flex;
  align-items: center;
  gap: 10px;
}

.upload-area {
  border: 2px dashed rgba(0,255,255,0.4);
  border-radius: var(--radius);
  padding: 40px;
  text-align: center;
  background: rgba(0,255,255,0.03);
  cursor: pointer;
  transition: var(--transition);
}

.upload-area:hover, .upload-area.dragover {
  background: rgba(0,255,255,0.08);
  border-color: var(--color-accent);
}

input[type="file"] {
  display: none;
}

.btn {
  background: var(--color-accent);
  color: #0d1117;
  border: none;
  padding: 12px 24px;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  transition: var(--transition);
  margin: 5px;
}

.btn:hover {
  background: #00c4cc;
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0,255,255,0.4);
}

.btn-secondary {
  background: rgba(0,255,255,0.2);
  color: var(--color-accent);
  border: 1px solid var(--color-accent);
}

.btn-secondary:hover {
  background: rgba(0,255,255,0.3);
}

.input-group {
  margin-bottom: 15px;
}

.input-group label {
  display: block;
  margin-bottom: 8px;
  color: var(--color-text);
  font-weight: 500;
}

.input-group input, .input-group select, .input-group textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid rgba(0,255,255,0.3);
  background: rgba(0,255,255,0.05);
  color: var(--color-text);
  border-radius: var(--radius);
  font-size: 14px;
  font-family: 'Inter', sans-serif;
  transition: var(--transition);
}

.input-group input:focus, .input-group select:focus, .input-group textarea:focus {
  outline: none;
  border-color: var(--color-accent);
  background: rgba(0,255,255,0.1);
}

.output-area {
  background: #000000;
  color: #00ff00;
  padding: 20px;
  border-radius: var(--radius);
  max-height: 500px;
  overflow-y: auto;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  white-space: pre-wrap;
  word-wrap: break-word;
  border: 1px solid rgba(0,255,255,0.3);
}

.file-info {
  background: rgba(0,255,255,0.05);
  padding: 15px;
  border-radius: var(--radius);
  margin-top: 15px;
  display: none;
  border: 1px solid rgba(0,255,255,0.2);
}

.file-info.show {
  display: block;
}

.status {
  padding: 12px;
  border-radius: var(--radius);
  margin-top: 15px;
  text-align: center;
  font-weight: 600;
}

.status.success {
  background: rgba(0,210,106,0.2);
  color: var(--color-success);
  border: 1px solid var(--color-success);
}

.status.error {
  background: rgba(255,60,60,0.2);
  color: var(--color-error);
  border: 1px solid var(--color-error);
}

.status.info {
  background: rgba(0,255,255,0.2);
  color: var(--color-accent);
  border: 1px solid var(--color-accent);
}

.loader {
  border: 4px solid rgba(0,255,255,0.1);
  border-top: 4px solid var(--color-accent);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 20px auto;
  display: none;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

@media (max-width: 768px) {
  .sidebar { width: 70px; }
  .sidebar h1 { display: none; }
  .nav-item span { display: none; }
  .grid { grid-template-columns: 1fr; }
}
</style>
</head>

<body>
<!-- SIDEBAR -->
<aside class="sidebar">
  <h1><i class="fas fa-exchange-alt"></i> Conversor</h1>
  <div class="nav-item active"><i class="fas fa-file-upload"></i><span>Cargar</span></div>
  <div class="nav-item"><i class="fas fa-language"></i><span>Traducir</span></div>
  <div class="nav-item"><i class="fas fa-code"></i><span>Resultado</span></div>
  <div class="nav-item"><i class="fas fa-download"></i><span>Descargar</span></div>
</aside>

<!-- MAIN -->
<main class="main">
  <div class="topbar">
    <div class="title"><i class="fas fa-file-code"></i> Conversor a JSON Dataset</div>
    <div class="actions">
      <i class="fas fa-sun" id="theme-toggle"></i>
      <i class="fas fa-info-circle"></i>
    </div>
  </div>

  <div class="content">
    <!-- Secci√≥n de carga -->
    <div class="section">
      <h2><i class="fas fa-upload"></i> 1. Cargar Archivo o Texto</h2>
      <div class="upload-area" id="uploadArea">
        <p style="font-size: 48px; margin-bottom: 10px;">üìÅ</p>
        <p style="font-size: 18px; margin-bottom: 10px;">Arrastra tu archivo aqu√≠</p>
        <p style="opacity: 0.7; margin-bottom: 20px;">o haz clic para seleccionar</p>
        <button class="btn" onclick="document.getElementById('fileInput').click()">
          <i class="fas fa-file"></i> Seleccionar Archivo
        </button>
        <input type="file" id="fileInput" accept=".txt,.doc,.docx,.pdf,.csv,.xml,.json">
        <p style="opacity: 0.6; margin-top: 15px; font-size: 12px;">Formatos: TXT, DOC, DOCX, PDF, CSV, XML, JSON</p>
      </div>
      <div class="file-info" id="fileInfo"></div>
      
      <div class="input-group" style="margin-top: 20px;">
        <label><i class="fas fa-edit"></i> O escribe/pega tu texto directamente:</label>
        <textarea id="directText" rows="6" placeholder="Escribe o pega tu texto aqu√≠..."></textarea>
      </div>
    </div>

    <!-- Secci√≥n de traducci√≥n -->
    <div class="section">
      <h2><i class="fas fa-language"></i> 2. Opciones de Traducci√≥n</h2>
      <div class="input-group">
        <label>
          <input type="checkbox" id="translateOption" style="width: auto; margin-right: 10px;">
          <i class="fas fa-globe"></i> Traducir contenido del ingl√©s al espa√±ol
        </label>
      </div>
      <div class="input-group">
        <label>Tama√±o m√°ximo por fragmento (caracteres):</label>
        <input type="number" id="chunkSize" value="3000" min="1000" max="8000">
        <p style="font-size: 12px; opacity: 0.7; margin-top: 5px;">
          <i class="fas fa-info-circle"></i> Textos largos se dividir√°n autom√°ticamente
        </p>
      </div>
    </div>

    <!-- Secci√≥n de procesamiento -->
    <div class="section">
      <h2><i class="fas fa-cogs"></i> 3. Procesar y Convertir</h2>
      <button class="btn" onclick="processFile()">
        <i class="fas fa-sync-alt"></i> Convertir a JSON
      </button>
      <button class="btn btn-secondary" onclick="downloadJSON()">
        <i class="fas fa-download"></i> Descargar JSON
      </button>
      <button class="btn btn-secondary" onclick="clearAll()">
        <i class="fas fa-trash"></i> Limpiar Todo
      </button>
      <div class="loader" id="loader"></div>
      <div id="status"></div>
    </div>

    <!-- Secci√≥n de resultado -->
    <div class="section">
      <h2><i class="fas fa-code"></i> 4. Resultado JSON</h2>
      <div class="output-area" id="output">// El JSON aparecer√° aqu√≠ despu√©s de procesar...</div>
    </div>
  </div>
</main>

<script>
let currentFile = null;
let jsonResult = null;

// Drag and drop
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');

uploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
  uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    handleFile(files[0]);
  }
});

fileInput.addEventListener('change', (e) => {
  if (e.target.files.length > 0) {
    handleFile(e.target.files[0]);
  }
});

// Tema
document.getElementById('theme-toggle').addEventListener('click', () => {
  if (document.documentElement.style.getPropertyValue('--color-bg') === '#f0f2f5') {
    document.documentElement.style.setProperty('--color-bg', '#0d1117');
    document.documentElement.style.setProperty('--color-text', '#e6e6e6');
    document.documentElement.style.setProperty('--color-panel', 'rgba(255,255,255,0.06)');
    document.getElementById('theme-toggle').classList.replace('fa-moon', 'fa-sun');
  } else {
    document.documentElement.style.setProperty('--color-bg', '#f0f2f5');
    document.documentElement.style.setProperty('--color-text', '#222');
    document.documentElement.style.setProperty('--color-panel', 'rgba(0,0,0,0.05)');
    document.getElementById('theme-toggle').classList.replace('fa-sun', 'fa-moon');
  }
});

function handleFile(file) {
  currentFile = file;
  const fileInfo = document.getElementById('fileInfo');
  fileInfo.innerHTML = `
    <p><strong><i class="fas fa-file"></i> Archivo:</strong> ${file.name}</p>
    <p><strong><i class="fas fa-hdd"></i> Tama√±o:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
    <p><strong><i class="fas fa-info"></i> Tipo:</strong> ${file.type || 'Desconocido'}</p>
  `;
  fileInfo.classList.add('show');
  showStatus('‚úì Archivo cargado. Configura opciones y presiona "Convertir a JSON"', 'success');
}

async function processFile() {
  const directText = document.getElementById('directText').value.trim();
  
  if (!currentFile && !directText) {
    showStatus('Por favor, carga un archivo o escribe texto', 'error');
    return;
  }

  showLoader(true);
  showStatus('Procesando...', 'info');

  try {
    let content = directText || await readFile(currentFile);
    
    // Traducir si est√° habilitado
    if (document.getElementById('translateOption').checked) {
      content = await translateToSpanish(content);
    }

    // Crear JSON simple (solo el texto, sin metadatos)
    jsonResult = { content: content };
    
    document.getElementById('output').textContent = JSON.stringify(jsonResult, null, 2);
    showStatus('‚úÖ Conversi√≥n exitosa', 'success');
  } catch (error) {
    showStatus('‚ùå Error: ' + error.message, 'error');
    console.error(error);
  } finally {
    showLoader(false);
  }
}

async function readFile(file) {
  const extension = file.name.split('.').pop().toLowerCase();
  
  switch(extension) {
    case 'txt':
      return await readAsText(file);
    case 'csv':
      return await readCSV(file);
    case 'xml':
      return await readXML(file);
    case 'json':
      const jsonData = await readJSON(file);
      return typeof jsonData === 'string' ? jsonData : JSON.stringify(jsonData);
    case 'pdf':
      return await readAsText(file);
    case 'doc':
    case 'docx':
      return await readDOCX(file);
    default:
      throw new Error('Formato no soportado: ' + extension);
  }
}

function readAsText(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result);
    reader.onerror = reject;
    reader.readAsText(file);
  });
}

async function readCSV(file) {
  return new Promise((resolve, reject) => {
    Papa.parse(file, {
      header: true,
      complete: (results) => resolve(JSON.stringify(results.data, null, 2)),
      error: reject
    });
  });
}

async function readXML(file) {
  const text = await readAsText(file);
  const parser = new DOMParser();
  const xmlDoc = parser.parseFromString(text, "text/xml");
  return JSON.stringify(xmlToJson(xmlDoc), null, 2);
}

function xmlToJson(xml) {
  let obj = {};
  if (xml.nodeType === 1) {
    if (xml.attributes.length > 0) {
      obj["@attributes"] = {};
      for (let j = 0; j < xml.attributes.length; j++) {
        const attribute = xml.attributes.item(j);
        obj["@attributes"][attribute.nodeName] = attribute.nodeValue;
      }
    }
  } else if (xml.nodeType === 3) {
    obj = xml.nodeValue;
  }
  if (xml.hasChildNodes()) {
    for (let i = 0; i < xml.childNodes.length; i++) {
      const item = xml.childNodes.item(i);
      const nodeName = item.nodeName;
      if (typeof obj[nodeName] === "undefined") {
        obj[nodeName] = xmlToJson(item);
      } else {
        if (typeof obj[nodeName].push === "undefined") {
          const old = obj[nodeName];
          obj[nodeName] = [];
          obj[nodeName].push(old);
        }
        obj[nodeName].push(xmlToJson(item));
      }
    }
  }
  return obj;
}

async function readJSON(file) {
  const text = await readAsText(file);
  return JSON.parse(text);
}

async function readDOCX(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const arrayBuffer = e.target.result;
        const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
        resolve(result.value);
      } catch (error) {
        reject(error);
      }
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

async function translateToSpanish(content) {
  showStatus('üåê Traduciendo al espa√±ol...', 'info');
  
  const textToTranslate = typeof content === 'string' ? content : JSON.stringify(content);
  const chunkSize = parseInt(document.getElementById('chunkSize').value) || 3000;
  
  // Dividir en fragmentos
  const chunks = [];
  for (let i = 0; i < textToTranslate.length; i += chunkSize) {
    chunks.push(textToTranslate.slice(i, i + chunkSize));
  }
  
  showStatus(`üåê Traduciendo ${chunks.length} fragmento(s)...`, 'info');
  
  let translatedParts = [];
  
  for (let i = 0; i < chunks.length; i++) {
    try {
      showStatus(`üåê Traduciendo parte ${i + 1} de ${chunks.length}...`, 'info');
      
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 4096,
          messages: [
            { 
              role: "user", 
              content: `Traduce COMPLETAMENTE este texto del ingl√©s al espa√±ol mexicano. Mant√©n el formato original. NO agregues explicaciones, solo traduce TODO el contenido:\n\n${chunks[i]}`
            }
          ],
        })
      });

      const data = await response.json();
      const translated = data.content
        .map(item => (item.type === "text" ? item.text : ""))
        .filter(Boolean)
        .join("\n");
      
      translatedParts.push(translated);
      
      // Pausa entre llamadas
      if (i < chunks.length - 1) {
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    } catch (error) {
      console.error(`Error en fragmento ${i + 1}:`, error);
      showStatus(`‚ö†Ô∏è Error en fragmento ${i + 1}, continuando...`, 'info');
      translatedParts.push(chunks[i]); // Agregar original si falla
    }
  }
  
  return translatedParts.join('\n');
}

function downloadJSON() {
  if (!jsonResult) {
    showStatus('Primero debes procesar un archivo', 'error');
    return;
  }

  const dataStr = JSON.stringify(jsonResult, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `converted_${Date.now()}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showStatus('üì• JSON descargado', 'success');
}

function clearAll() {
  currentFile = null;
  jsonResult = null;
  document.getElementById('fileInput').value = '';
  document.getElementById('directText').value = '';
  document.getElementById('fileInfo').classList.remove('show');
  document.getElementById('output').textContent = '// El JSON aparecer√° aqu√≠ despu√©s de procesar...';
  document.getElementById('translateOption').checked = false;
  document.getElementById('status').innerHTML = '';
  showStatus('üîÑ Todo limpiado', 'info');
}

function showStatus(message, type) {
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = `status ${type}`;
}

function showLoader(show) {
  document.getElementById('loader').style.display = show ? 'block' : 'none';
}
</script>
</body>
</html>