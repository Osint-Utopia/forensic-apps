<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Documentos Legales</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: white;
            border-bottom: 3px solid #007bff;
            color: #007bff;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 3px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #0056b3;
            background: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #28a745;
            background: #f8fff8;
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }

        .file-info {
            display: flex;
            flex-direction: column;
        }

        .file-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .file-details {
            font-size: 12px;
            color: #6c757d;
        }

        .analysis-result {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .document-type {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px;
        }

        .type-legal { background: #e3f2fd; color: #1565c0; }
        .type-contract { background: #f3e5f5; color: #7b1fa2; }
        .type-letter { background: #e8f5e8; color: #2e7d32; }
        .type-report { background: #fff3e0; color: #ef6c00; }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s;
        }

        .analysis-section {
            margin: 20px 0;
            padding: 20px;
            border-left: 4px solid #007bff;
            background: white;
            border-radius: 5px;
        }

        .analysis-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .checklist-icon {
            margin-right: 10px;
            font-size: 18px;
        }

        .check-pass { color: #28a745; }
        .check-fail { color: #dc3545; }
        .check-warning { color: #ffc107; }

        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #007bff;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -22px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #007bff;
            border: 3px solid white;
        }

        .json-viewer {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            .container {
                margin: 10px;
            }
            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÑ Analizador de Documentos Legales</h1>
            <p>An√°lisis inteligente de documentos con IA jur√≠dica</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('upload')">üìÅ Subir Documentos</button>
            <button class="nav-tab" onclick="showTab('analyze')">üîç An√°lisis</button>
            <button class="nav-tab" onclick="showTab('reports')">üìä Informes</button>
            <button class="nav-tab" onclick="showTab('memory')">üíæ Memoria</button>
        </div>

        <!-- Tab: Upload -->
        <div id="upload" class="tab-content active">
            <h2>üìÅ Subida de Documentos</h2>
            
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 48px; margin-bottom: 20px;">üìÑ</div>
                <h3>Arrastra archivos aqu√≠ o haz clic para seleccionar</h3>
                <p>Soporta: PDF, DOCX, XLSX, CSV, JSON, JS, JPG, PNG</p>
                <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.docx,.xlsx,.csv,.json,.js,.jpg,.png">
            </div>

            <div class="export-options">
                <button class="btn btn-primary" onclick="document.getElementById('folderInput').click()">
                    üìÅ Subir Carpeta Completa
                </button>
                <input type="file" id="folderInput" class="file-input" webkitdirectory multiple>
                <button class="btn btn-success" onclick="processFiles()">üöÄ Procesar Archivos</button>
                <button class="btn btn-warning" onclick="clearFiles()">üóëÔ∏è Limpiar Lista</button>
            </div>

            <div id="fileList" class="file-list"></div>
        </div>

        <!-- Tab: Analyze -->
        <div id="analyze" class="tab-content">
            <h2>üîç An√°lisis de Documentos</h2>
            
            <div id="analysisResults"></div>
            
            <div class="analysis-section">
                <h3>üìã Lista de Verificaci√≥n</h3>
                <div id="checklistResults"></div>
            </div>

            <div class="analysis-section">
                <h3>‚öñÔ∏è Marco Legal</h3>
                <div id="legalFramework"></div>
            </div>

            <div class="analysis-section">
                <h3>üìà Timeline de Documentos</h3>
                <div id="timeline" class="timeline"></div>
            </div>
        </div>

        <!-- Tab: Reports -->
        <div id="reports" class="tab-content">
            <h2>üìä Generaci√≥n de Informes</h2>
            
            <div class="summary-card">
                <h3>üìù Resumen Ejecutivo</h3>
                <div id="executiveSummary"></div>
                
                <div class="export-options">
                    <button class="btn btn-primary" onclick="exportToPDF('summary')">üìÑ Exportar PDF</button>
                    <button class="btn btn-success" onclick="exportToWord('summary')">üìù Exportar DOCX</button>
                </div>
            </div>

            <div class="summary-card">
                <h3>üìã Informe Detallado</h3>
                <div id="detailedReport"></div>
                
                <div class="export-options">
                    <button class="btn btn-primary" onclick="exportToPDF('detailed')">üìÑ Exportar PDF</button>
                    <button class="btn btn-success" onclick="exportToWord('detailed')">üìù Exportar DOCX</button>
                </div>
            </div>
        </div>

        <!-- Tab: Memory -->
        <div id="memory" class="tab-content">
            <h2>üíæ Memoria y Base de Conocimientos</h2>
            
            <div class="summary-card">
                <h3>üß† Memoria de Documentos</h3>
                <div id="documentMemory"></div>
                
                <div class="export-options">
                    <button class="btn btn-primary" onclick="exportMemoryJSON()">üíæ Exportar JSON</button>
                    <button class="btn btn-success" onclick="loadMemoryJSON()">üìÇ Cargar Memoria</button>
                    <input type="file" id="memoryInput" class="file-input" accept=".json">
                </div>
            </div>

            <div class="summary-card">
                <h3>üìö Librer√≠a de Conocimientos</h3>
                <div id="knowledgeBase" class="json-viewer"></div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let uploadedFiles = [];
        let analysisResults = {};
        let documentMemory = {};
        let knowledgeBase = {};

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadStoredMemory();
        });

        function setupEventListeners() {
            // Drag and drop
            const uploadArea = document.querySelector('.upload-area');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            // File inputs
            document.getElementById('fileInput').addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            document.getElementById('folderInput').addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            document.getElementById('memoryInput').addEventListener('change', (e) => {
                loadMemoryFromFile(e.target.files[0]);
            });
        }

        function showTab(tabName) {
            // Ocultar todas las tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar tab seleccionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (!uploadedFiles.find(f => f.name === file.name && f.size === file.size)) {
                    uploadedFiles.push(file);
                }
            });
            displayFileList();
        }

        function displayFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileType = getFileType(file.name);
                const fileIcon = getFileIcon(fileType);
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${fileIcon} ${file.name}</div>
                        <div class="file-details">
                            Tipo: ${fileType} | Tama√±o: ${formatFileSize(file.size)} | 
                            Modificado: ${new Date(file.lastModified).toLocaleString()}
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="removeFile(${index})">‚ùå</button>
                    </div>
                `;
                
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            displayFileList();
        }

        function clearFiles() {
            uploadedFiles = [];
            displayFileList();
        }

        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const types = {
                'pdf': 'PDF',
                'docx': 'Word',
                'doc': 'Word',
                'xlsx': 'Excel',
                'xls': 'Excel',
                'csv': 'CSV',
                'json': 'JSON',
                'js': 'JavaScript',
                'jpg': 'Imagen',
                'jpeg': 'Imagen',
                'png': 'Imagen'
            };
            return types[ext] || 'Desconocido';
        }

        function getFileIcon(type) {
            const icons = {
                'PDF': 'üìÑ',
                'Word': 'üìù',
                'Excel': 'üìä',
                'CSV': 'üìã',
                'JSON': 'üîß',
                'JavaScript': 'üíª',
                'Imagen': 'üñºÔ∏è'
            };
            return icons[type] || 'üìé';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function processFiles() {
            if (uploadedFiles.length === 0) {
                alert('Por favor, sube al menos un archivo.');
                return;
            }

            showLoadingState();
            
            try {
                for (let file of uploadedFiles) {
                    await analyzeFile(file);
                }
                
                generateAnalysisResults();
                generateReports();
                updateMemory();
                
                // Cambiar a la tab de an√°lisis
                showTab('analyze');
                document.querySelector('[onclick="showTab(\'analyze\')"]').click();
                
            } catch (error) {
                console.error('Error procesando archivos:', error);
                showAlert('Error al procesar archivos: ' + error.message, 'danger');
            } finally {
                hideLoadingState();
            }
        }

        async function analyzeFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const content = e.target.result;
                    const analysis = performAnalysis(file, content);
                    analysisResults[file.name] = analysis;
                    resolve(analysis);
                };
                
                if (file.type.includes('text') || file.name.endsWith('.json') || file.name.endsWith('.js')) {
                    reader.readAsText(file);
                } else {
                    // Para archivos binarios, simular extracci√≥n de texto
                    reader.readAsArrayBuffer(file);
                    setTimeout(() => {
                        const simulatedText = simulateTextExtraction(file);
                        const analysis = performAnalysis(file, simulatedText);
                        analysisResults[file.name] = analysis;
                        resolve(analysis);
                    }, 1000);
                }
            });
        }

        function simulateTextExtraction(file) {
            // Simulaci√≥n de extracci√≥n de texto para diferentes tipos de archivo
            const fileType = getFileType(file.name);
            
            const sampleTexts = {
                'PDF': 'CONTRATO DE PRESTACI√ìN DE SERVICIOS\n\nEntre los comparecientes, de una parte DON/DO√ëA [NOMBRE], mayor de edad, con DNI [N√öMERO], en calidad de CONTRATANTE, y de otra parte DON/DO√ëA [NOMBRE], mayor de edad, con DNI [N√öMERO], en calidad de CONTRATISTA.\n\nCL√ÅUSULAS:\nPRIMERA.- OBJETO DEL CONTRATO\nEl contratista se compromete a realizar los servicios de [DESCRIPCI√ìN].\n\nSEGUNDA.- DURACI√ìN\nEl presente contrato tendr√° una duraci√≥n de [TIEMPO].\n\nTERCERA.- PRECIO Y FORMA DE PAGO\nEl precio total de los servicios asciende a [CANTIDAD] euros.',
                
                'Word': 'CARTA COMERCIAL\n\nMuy se√±ores nuestros:\n\nNos dirigimos a ustedes para comunicarles que hemos recibido su propuesta comercial del pasado d√≠a [FECHA], la cual hemos analizado detenidamente.\n\nTras estudiar las condiciones propuestas, nos complace informarles que aceptamos su oferta, siempre y cuando se modifiquen los siguientes t√©rminos:\n\n1. Plazo de entrega: 30 d√≠as naturales\n2. Forma de pago: 50% al pedido, 50% a la entrega\n3. Garant√≠a: 2 a√±os\n\nQuedaremos a la espera de su confirmaci√≥n.',
                
                'Excel': 'PRESUPUESTO ANUAL 2024\n\nITEM\tCONCEPTO\tCANTIDAD\tPRECIO UNIT.\tTOTAL\n001\tServicios profesionales\t12\t2500\t30000\n002\tMaterial de oficina\t1\t1200\t1200\n003\tEquipamiento inform√°tico\t5\t800\t4000\n004\tGastos de desplazamiento\t24\t150\t3600\n\nTOTAL PRESUPUESTO: 38,800 ‚Ç¨',
                
                'Imagen': 'DOCUMENTO ESCANEADO\n\nRESOLUCI√ìN ADMINISTRATIVA\n\nVISTO: El expediente iniciado a solicitud de [NOMBRE] para [MOTIVO].\n\nCONSIDERANDO: Que se han cumplido todos los requisitos legales establecidos en la normativa vigente.\n\nRESOLVEMOS:\n\nPRIMERO.- Conceder la autorizaci√≥n solicitada.\nSEGUNDO.- Notificar al interesado.\nTERCERO.- Dar traslado al departamento correspondiente.'
            };
            
            return sampleTexts[fileType] || 'Contenido de texto extra√≠do del archivo ' + file.name;
        }

        function performAnalysis(file, content) {
            const analysis = {
                fileName: file.name,
                fileType: getFileType(file.name),
                size: file.size,
                lastModified: new Date(file.lastModified),
                documentType: classifyDocument(content),
                structure: analyzeStructure(content),
                legalElements: extractLegalElements(content),
                formalChecklist: performFormalCheck(content),
                semanticAnalysis: performSemanticAnalysis(content),
                summary: generateSummary(content),
                riskLevel: assessRiskLevel(content),
                textContent: content.substring(0, 1000) + (content.length > 1000 ? '...' : '')
            };
            
            return analysis;
        }

        function classifyDocument(content) {
            const patterns = {
                'Contrato': /contrat[oa]|cl[a√°]usul|acuerdo|partes|contratante|contratista/i,
                'Carta Comercial': /estimados|se[√±n]ores|salud[oa]|atentamente|cordialmente/i,
                'Resoluci√≥n': /resoluci[o√≥]n|visto|considerando|resolvemos|dispongo/i,
                'Demanda': /demanda|juzgado|tribunal|actor|demandado|s[√∫u]plica/i,
                'Presupuesto': /presupuesto|importe|total|cantidad|precio|factura/i,
                'Informe': /informe|an[a√°]lisis|conclusi[o√≥]n|recomendaci[o√≥]n/i
            };
            
            for (let type in patterns) {
                if (patterns[type].test(content)) {
                    return type;
                }
            }
            
            return 'Documento General';
        }

        function analyzeStructure(content) {
            const structure = {
                hasHeader: /^[A-Z√Å√â√ç√ì√ö√ë\s]{3,50}$/m.test(content),
                hasClauses: /cl[a√°]usul|art[i√≠]cul|apartado|secci[o√≥]n/i.test(content),
                hasSignature: /firma|fdo\.|atentamente|cordialmente/i.test(content),
                hasDate: /\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}|\d{1,2}\s+de\s+\w+\s+de\s+\d{4}/i.test(content),
                paragraphs: content.split('\n\n').length,
                wordCount: content.split(/\s+/).length
            };
            
            return structure;
        }

        function extractLegalElements(content) {
            const elements = {
                laws: content.match(/ley\s+\d+\/\d+|real\s+decreto\s+\d+\/\d+|orden\s+\w+\/\d+/gi) || [],
                articles: content.match(/art[i√≠]culo\s+\d+|art\.\s*\d+/gi) || [],
                references: content.match(/en\s+virtud\s+de|de\s+conformidad\s+con|seg[u√∫]n\s+establece/gi) || [],
                dates: content.match(/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}|\d{1,2}\s+de\s+\w+\s+de\s+\d{4}/gi) || []
            };
            
            return elements;
        }

        function performFormalCheck(content) {
            const checks = [
                {
                    name: 'Encabezado presente',
                    passed: /^[A-Z√Å√â√ç√ì√ö√ë\s]{3,50}/m.test(content),
                    importance: 'alta'
                },
                {
                    name: 'Estructura de p√°rrafos',
                    passed: content.split('\n\n').length > 2,
                    importance: 'media'
                },
                {
                    name: 'Fecha incluida',
                    passed: /\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}|\d{1,2}\s+de\s+\w+\s+de\s+\d{4}/i.test(content),
                    importance: 'alta'
                },
                {
                    name: 'Firma o cierre formal',
                    passed: /firma|fdo\.|atentamente|cordialmente/i.test(content),
                    importance: 'media'
                },
                {
                    name: 'Extensi√≥n adecuada',
                    passed: content.length > 100,
                    importance: 'baja'
                }
            ];
            
            return checks;
        }

        function performSemanticAnalysis(content) {
            const analysis = {
                tone: getTone(content),
                formality: getFormalityLevel(content),
                complexity: getComplexityLevel(content),
                keyTerms: extractKeyTerms(content),
                sentiment: getSentiment(content)
            };
            
            return analysis;
        }

        function getTone(content) {
            if (/urgente|inmediato|cr[i√≠]tico/i.test(content)) return 'Urgente';
            if (/formal|respetuosamente|atentamente/i.test(content)) return 'Formal';
            if (/amigable|cordial/i.test(content)) return 'Cordial';
            return 'Neutral';
        }

        function getFormalityLevel(content) {
            let score = 0;
            if (/usted|se[√±n]or[√≠a]a|don|do[√±n]a/i.test(content)) score += 2;
            if (/por\s+la\s+presente|mediante\s+el\s+presente/i.test(content)) score += 2;
            if (/atentamente|cordialmente|respetuosamente/i.test(content)) score += 1;
            
            if (score >= 4) return 'Muy Formal';
            if (score >= 2) return 'Formal';
            return 'Informal';
        }

        function getComplexityLevel(content) {
            const words = content.split(/\s+/);
            const avgWordLength = words.reduce((sum, word) => sum + word.length, 0) / words.length;
            const longSentences = content.split(/[.!?]/).filter(s => s.split(/\s+/).length > 20).length;
            
            if (avgWordLength > 8 || longSentences > 3) return 'Alta';
            if (avgWordLength > 6 || longSentences > 1) return 'Media';
            return 'Baja';
        }

        function extractKeyTerms(content) {
            const commonLegalTerms = [
                'contrato', 'cl√°usula', 'acuerdo', 'partes', 'obligaci√≥n', 'derecho',
                'responsabilidad', 'garant√≠a', 'indemnizaci√≥n', 'resoluci√≥n', 'incumplimiento',
                'notificaci√≥n', 'procedimiento', 'jurisdicci√≥n', 'competencia', 'tribunal'
            ];
            
            return commonLegalTerms.filter(term => 
                new RegExp(term, 'i').test(content)
            );
        }

        function getSentiment(content) {
            const positiveWords = /satisfactorio|excelente|bueno|√≥ptimo|correcto|adecuado/gi;
            const negativeWords = /problema|error|incorrecto|inadecuado|deficiente|insatisfactorio/gi;
            
            const positive = (content.match(positiveWords) || []).length;
            const negative = (content.match(negativeWords) || []).length;
            
            if (positive > negative) return 'Positivo';
            if (negative > positive) return 'Negativo';
            return 'Neutral';
        }

        function generateSummary(content) {
            const sentences = content.split(/[.!?]/).filter(s => s.trim().length > 20);
            const firstSentences = sentences.slice(0, 3).join('. ');
            return firstSentences.length > 200 ? 
                firstSentences.substring(0, 200) + '...' : 
                firstSentences;
        }

        function assessRiskLevel(content) {
            let riskScore = 0;
            
            // Factores de riesgo
            if (/incumplimiento|breach|violaci√≥n|infracci√≥n/i.test(content)) riskScore += 3;
            if (/demanda|litigation|tribunal|juzgado/i.test(content)) riskScore += 3;
            if (/urgente|inmediato|plazo|vencimiento/i.test(content)) riskScore += 2;
            if (/penalizaci√≥n|multa|sanci√≥n/i.test(content)) riskScore += 2;
            if (/revisi√≥n|modificaci√≥n|enmienda/i.test(content)) riskScore += 1;
            
            if (riskScore >= 6) return 'Alto';
            if (riskScore >= 3) return 'Medio';
            return 'Bajo';
        }

        function generateAnalysisResults() {
            const resultsContainer = document.getElementById('analysisResults');
            const checklistContainer = document.getElementById('checklistResults');
            const legalContainer = document.getElementById('legalFramework');
            const timelineContainer = document.getElementById('timeline');
            
            // Resultados de an√°lisis
            let resultsHTML = '<h3>üìä Resultados del An√°lisis</h3>';
            
            Object.values(analysisResults).forEach(analysis => {
                const typeClass = getDocumentTypeClass(analysis.documentType);
                
                resultsHTML += `
                    <div class="summary-card">
                        <h4>üìÑ ${analysis.fileName}</h4>
                        <div class="document-type ${typeClass}">${analysis.documentType}</div>
                        <p><strong>Riesgo:</strong> <span class="risk-${analysis.riskLevel.toLowerCase()}">${analysis.riskLevel}</span></p>
                        <p><strong>Complejidad:</strong> ${analysis.semanticAnalysis.complexity}</p>
                        <p><strong>Tono:</strong> ${analysis.semanticAnalysis.tone}</p>
                        <p><strong>Resumen:</strong> ${analysis.summary}</p>
                        
                        <div style="margin-top: 15px;">
                            <strong>Elementos legales encontrados:</strong>
                            <ul style="margin: 5px 0 0 20px;">
                                <li>Leyes: ${analysis.legalElements.laws.length}</li>
                                <li>Art√≠culos: ${analysis.legalElements.articles.length}</li>
                                <li>Referencias: ${analysis.legalElements.references.length}</li>
                            </ul>
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = resultsHTML;

            // Lista de verificaci√≥n
            let checklistHTML = '';
            Object.values(analysisResults).forEach(analysis => {
                checklistHTML += `<h4>‚úÖ ${analysis.fileName}</h4>`;
                analysis.formalChecklist.forEach(check => {
                    const icon = check.passed ? '‚úÖ' : '‚ùå';
                    const statusClass = check.passed ? 'check-pass' : 'check-fail';
                    
                    checklistHTML += `
                        <div class="checklist-item">
                            <span class="checklist-icon ${statusClass}">${icon}</span>
                            <span>${check.name} (${check.importance})</span>
                        </div>
                    `;
                });
            });
            
            checklistContainer.innerHTML = checklistHTML;

            // Marco legal
            let legalHTML = '<h4>‚öñÔ∏è Referencias Legales Identificadas</h4>';
            const allLaws = [];
            const allArticles = [];
            
            Object.values(analysisResults).forEach(analysis => {
                allLaws.push(...analysis.legalElements.laws);
                allArticles.push(...analysis.legalElements.articles);
            });
            
            const uniqueLaws = [...new Set(allLaws)];
            const uniqueArticles = [...new Set(allArticles)];
            
            legalHTML += `
                <div class="summary-card">
                    <h5>üìö Leyes y Decretos</h5>
                    ${uniqueLaws.length > 0 ? 
                        '<ul>' + uniqueLaws.map(law => `<li>${law}</li>`).join('') + '</ul>' :
                        '<p>No se encontraron referencias espec√≠ficas a leyes.</p>'
                    }
                    
                    <h5>üìñ Art√≠culos</h5>
                    ${uniqueArticles.length > 0 ? 
                        '<ul>' + uniqueArticles.map(art => `<li>${art}</li>`).join('') + '</ul>' :
                        '<p>No se encontraron referencias espec√≠ficas a art√≠culos.</p>'
                    }
                </div>
            `;
            
            legalContainer.innerHTML = legalHTML;

            // Timeline
            let timelineHTML = '';
            const sortedResults = Object.values(analysisResults).sort((a, b) => 
                new Date(a.lastModified) - new Date(b.lastModified)
            );
            
            sortedResults.forEach(analysis => {
                timelineHTML += `
                    <div class="timeline-item">
                        <h5>${analysis.fileName}</h5>
                        <p><strong>Fecha:</strong> ${analysis.lastModified.toLocaleDateString()}</p>
                        <p><strong>Tipo:</strong> ${analysis.documentType}</p>
                        <p><strong>Estado:</strong> ${getDocumentStatus(analysis)}</p>
                    </div>
                `;
            });
            
            timelineContainer.innerHTML = timelineHTML;
        }

        function getDocumentTypeClass(type) {
            const classes = {
                'Contrato': 'type-contract',
                'Carta Comercial': 'type-letter',
                'Resoluci√≥n': 'type-legal',
                'Demanda': 'type-legal',
                'Presupuesto': 'type-report',
                'Informe': 'type-report'
            };
            return classes[type] || 'type-legal';
        }

        function getDocumentStatus(analysis) {
            if (analysis.riskLevel === 'Alto') return '‚ö†Ô∏è Requiere Atenci√≥n';
            if (analysis.formalChecklist.some(check => !check.passed && check.importance === 'alta')) {
                return '‚ö†Ô∏è Revisi√≥n Necesaria';
            }
            return '‚úÖ Conforme';
        }

        function generateReports() {
            generateExecutiveSummary();
            generateDetailedReport();
        }

        function generateExecutiveSummary() {
            const container = document.getElementById('executiveSummary');
            const totalDocs = Object.keys(analysisResults).length;
            const riskDistribution = getRiskDistribution();
            const typeDistribution = getTypeDistribution();
            
            const summaryHTML = `
                <div class="summary-card">
                    <h4>üìà Estad√≠sticas Generales</h4>
                    <p><strong>Total de documentos analizados:</strong> ${totalDocs}</p>
                    <p><strong>Documentos de alto riesgo:</strong> ${riskDistribution.Alto || 0}</p>
                    <p><strong>Documentos de medio riesgo:</strong> ${riskDistribution.Medio || 0}</p>
                    <p><strong>Documentos de bajo riesgo:</strong> ${riskDistribution.Bajo || 0}</p>
                    
                    <h5>üìã Distribuci√≥n por Tipo</h5>
                    ${Object.entries(typeDistribution).map(([type, count]) => 
                        `<p><strong>${type}:</strong> ${count} documento(s)</p>`
                    ).join('')}
                    
                    <h5>‚ö†Ô∏è Recomendaciones Principales</h5>
                    <ul>
                        ${generateRecommendations().map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            container.innerHTML = summaryHTML;
        }

        function generateDetailedReport() {
            const container = document.getElementById('detailedReport');
            
            let detailedHTML = '<div class="summary-card">';
            
            Object.values(analysisResults).forEach(analysis => {
                detailedHTML += `
                    <div style="border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 20px;">
                        <h4>üìÑ ${analysis.fileName}</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
                            <div>
                                <h5>üìä Informaci√≥n General</h5>
                                <p><strong>Tipo:</strong> ${analysis.documentType}</p>
                                <p><strong>Tama√±o:</strong> ${formatFileSize(analysis.size)}</p>
                                <p><strong>Palabras:</strong> ${analysis.structure.wordCount}</p>
                                <p><strong>P√°rrafos:</strong> ${analysis.structure.paragraphs}</p>
                            </div>
                            
                            <div>
                                <h5>üéØ An√°lisis Sem√°ntico</h5>
                                <p><strong>Tono:</strong> ${analysis.semanticAnalysis.tone}</p>
                                <p><strong>Formalidad:</strong> ${analysis.semanticAnalysis.formality}</p>
                                <p><strong>Complejidad:</strong> ${analysis.semanticAnalysis.complexity}</p>
                                <p><strong>Sentimiento:</strong> ${analysis.semanticAnalysis.sentiment}</p>
                            </div>
                        </div>
                        
                        <h5>üîç T√©rminos Clave Identificados</h5>
                        <p>${analysis.semanticAnalysis.keyTerms.join(', ') || 'Ninguno'}</p>
                        
                        <h5>üìù Estructura del Documento</h5>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <span>Encabezado: ${analysis.structure.hasHeader ? '‚úÖ' : '‚ùå'}</span>
                            <span>Cl√°usulas: ${analysis.structure.hasClauses ? '‚úÖ' : '‚ùå'}</span>
                            <span>Firma: ${analysis.structure.hasSignature ? '‚úÖ' : '‚ùå'}</span>
                            <span>Fecha: ${analysis.structure.hasDate ? '‚úÖ' : '‚ùå'}</span>
                        </div>
                        
                        <h5>üìã Resumen del Contenido</h5>
                        <p style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-style: italic;">
                            ${analysis.summary}
                        </p>
                    </div>
                `;
            });
            
            detailedHTML += '</div>';
            container.innerHTML = detailedHTML;
        }

        function getRiskDistribution() {
            const distribution = {};
            Object.values(analysisResults).forEach(analysis => {
                distribution[analysis.riskLevel] = (distribution[analysis.riskLevel] || 0) + 1;
            });
            return distribution;
        }

        function getTypeDistribution() {
            const distribution = {};
            Object.values(analysisResults).forEach(analysis => {
                distribution[analysis.documentType] = (distribution[analysis.documentType] || 0) + 1;
            });
            return distribution;
        }

        function generateRecommendations() {
            const recommendations = [];
            const riskDistribution = getRiskDistribution();
            
            if (riskDistribution.Alto > 0) {
                recommendations.push(`Revisar urgentemente ${riskDistribution.Alto} documento(s) de alto riesgo`);
            }
            
            const formalIssues = Object.values(analysisResults).filter(a => 
                a.formalChecklist.some(check => !check.passed && check.importance === 'alta')
            ).length;
            
            if (formalIssues > 0) {
                recommendations.push(`${formalIssues} documento(s) requieren correcci√≥n de formato`);
            }
            
            const contractsCount = Object.values(analysisResults).filter(a => 
                a.documentType === 'Contrato'
            ).length;
            
            if (contractsCount > 0) {
                recommendations.push(`Verificar ${contractsCount} contrato(s) con asesor√≠a legal especializada`);
            }
            
            if (recommendations.length === 0) {
                recommendations.push('Todos los documentos cumplen con los est√°ndares b√°sicos');
            }
            
            return recommendations;
        }

        function updateMemory() {
            // Actualizar memoria de documentos
            Object.values(analysisResults).forEach(analysis => {
                const key = analysis.fileName;
                documentMemory[key] = {
                    fileName: analysis.fileName,
                    type: analysis.documentType,
                    summary: analysis.summary,
                    keyTerms: analysis.semanticAnalysis.keyTerms,
                    riskLevel: analysis.riskLevel,
                    processedDate: new Date().toISOString(),
                    legalElements: analysis.legalElements
                };
            });
            
            // Actualizar base de conocimientos
            updateKnowledgeBase();
            
            // Mostrar memoria actualizada
            displayMemory();
        }

        function updateKnowledgeBase() {
            // Extraer t√©rminos y conceptos para la base de conocimientos
            const allTerms = [];
            const allLegalReferences = [];
            const documentTypes = new Set();
            
            Object.values(analysisResults).forEach(analysis => {
                allTerms.push(...analysis.semanticAnalysis.keyTerms);
                allLegalReferences.push(...analysis.legalElements.laws);
                allLegalReferences.push(...analysis.legalElements.articles);
                documentTypes.add(analysis.documentType);
            });
            
            knowledgeBase = {
                lastUpdated: new Date().toISOString(),
                totalDocuments: Object.keys(documentMemory).length,
                commonTerms: [...new Set(allTerms)],
                legalReferences: [...new Set(allLegalReferences)],
                documentTypes: [...documentTypes],
                patterns: extractPatterns(),
                statistics: {
                    avgComplexity: calculateAverageComplexity(),
                    riskDistribution: getRiskDistribution(),
                    typeDistribution: getTypeDistribution()
                }
            };
            
            displayKnowledgeBase();
        }

        function extractPatterns() {
            const patterns = {
                commonStructures: [],
                frequentClauses: [],
                riskIndicators: []
            };
            
            // Aqu√≠ se implementar√≠a l√≥gica m√°s avanzada de ML
            // Por ahora, patrones b√°sicos
            Object.values(analysisResults).forEach(analysis => {
                if (analysis.structure.hasClauses) {
                    patterns.commonStructures.push('Estructura con cl√°usulas');
                }
                if (analysis.riskLevel === 'Alto') {
                    patterns.riskIndicators.push(analysis.semanticAnalysis.keyTerms);
                }
            });
            
            return patterns;
        }

        function calculateAverageComplexity() {
            const complexityValues = { 'Baja': 1, 'Media': 2, 'Alta': 3 };
            const total = Object.values(analysisResults).reduce((sum, analysis) => 
                sum + complexityValues[analysis.semanticAnalysis.complexity], 0
            );
            const avg = total / Object.keys(analysisResults).length;
            
            if (avg >= 2.5) return 'Alta';
            if (avg >= 1.5) return 'Media';
            return 'Baja';
        }

        function displayMemory() {
            const container = document.getElementById('documentMemory');
            
            let memoryHTML = `
                <div class="summary-card">
                    <h4>üìö Documentos en Memoria (${Object.keys(documentMemory).length})</h4>
            `;
            
            Object.values(documentMemory).forEach(doc => {
                memoryHTML += `
                    <div style="border-left: 4px solid #007bff; padding: 15px; margin: 10px 0; background: #f8f9fa;">
                        <h5>${doc.fileName}</h5>
                        <p><strong>Tipo:</strong> ${doc.type}</p>
                        <p><strong>Riesgo:</strong> ${doc.riskLevel}</p>
                        <p><strong>Procesado:</strong> ${new Date(doc.processedDate).toLocaleString()}</p>
                        <p><strong>Resumen:</strong> ${doc.summary}</p>
                        <p><strong>T√©rminos clave:</strong> ${doc.keyTerms.join(', ')}</p>
                    </div>
                `;
            });
            
            memoryHTML += '</div>';
            container.innerHTML = memoryHTML;
        }

        function displayKnowledgeBase() {
            const container = document.getElementById('knowledgeBase');
            container.textContent = JSON.stringify(knowledgeBase, null, 2);
        }

        function exportToPDF(type) {
            const content = getExportContent(type);
            
            // Crear elemento para descargar
            const element = document.createElement('a');
            const file = new Blob([content], { type: 'text/plain' });
            element.href = URL.createObjectURL(file);
            element.download = `informe_${type}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            
            showAlert('Informe exportado como archivo de texto (PDF requiere librer√≠a externa)', 'success');
        }

        function exportToWord(type) {
            const content = getExportContent(type);
            
            // Crear elemento para descargar
            const element = document.createElement('a');
            const file = new Blob([content], { type: 'text/plain' });
            element.href = URL.createObjectURL(file);
            element.download = `informe_${type}_${new Date().toISOString().split('T')[0]}.docx`;
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            
            showAlert('Informe exportado como archivo de texto (DOCX requiere librer√≠a externa)', 'success');
        }

        function getExportContent(type) {
            const date = new Date().toLocaleDateString();
            let content = `INFORME DE AN√ÅLISIS DE DOCUMENTOS LEGALES\n`;
            content += `Fecha: ${date}\n`;
            content += `Tipo: ${type === 'summary' ? 'Resumen Ejecutivo' : 'Informe Detallado'}\n`;
            content += `${'='.repeat(60)}\n\n`;
            
            if (type === 'summary') {
                content += document.getElementById('executiveSummary').textContent;
            } else {
                content += document.getElementById('detailedReport').textContent;
            }
            
            content += `\n\n${'='.repeat(60)}\n`;
            content += `Generado por Analizador de Documentos Legales v1.0\n`;
            
            return content;
        }

        function exportMemoryJSON() {
            const memoryData = {
                documentMemory: documentMemory,
                knowledgeBase: knowledgeBase,
                exportDate: new Date().toISOString()
            };
            
            const element = document.createElement('a');
            const file = new Blob([JSON.stringify(memoryData, null, 2)], { type: 'application/json' });
            element.href = URL.createObjectURL(file);
            element.download = `memoria_documentos_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            
            showAlert('Memoria exportada exitosamente', 'success');
        }

        function loadMemoryJSON() {
            document.getElementById('memoryInput').click();
        }

        function loadMemoryFromFile(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.documentMemory) documentMemory = data.documentMemory;
                    if (data.knowledgeBase) knowledgeBase = data.knowledgeBase;
                    
                    displayMemory();
                    displayKnowledgeBase();
                    
                    showAlert('Memoria cargada exitosamente', 'success');
                } catch (error) {
                    showAlert('Error al cargar el archivo de memoria', 'danger');
                }
            };
            reader.readAsText(file);
        }

        function loadStoredMemory() {
            // En un entorno real, esto cargar√≠a desde una base de datos
            // Por ahora, mantener memoria vac√≠a al inicio
            displayMemory();
            displayKnowledgeBase();
        }

        function showLoadingState() {
            const loading = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Procesando documentos...</p>
                </div>
            `;
            
            document.getElementById('analysisResults').innerHTML = loading;
        }

        function hideLoadingState() {
            // Se oculta autom√°ticamente al mostrar los resultados
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            // Insertar al principio del contenedor actual
            const activeTab = document.querySelector('.tab-content.active');
            activeTab.insertBefore(alertDiv, activeTab.firstChild);
            
            // Remover despu√©s de 5 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // Funciones auxiliares adicionales
        function simulateAIResponse(prompt, context) {
            // Simulaci√≥n de respuesta de IA para generar contra-argumentos o r√©plicas
            const responses = {
                'contrato': 'Con respecto al contrato presentado, se sugiere revisar las cl√°usulas de responsabilidad y establecer l√≠mites m√°s claros en cuanto a las obligaciones de cada parte.',
                'demanda': 'En relaci√≥n a la demanda presentada, se recomienda preparar una contestaci√≥n que incluya excepciones procesales y defensas de fondo basadas en la documentaci√≥n disponible.',
                'carta': 'Respecto a la comunicaci√≥n recibida, se sugiere una respuesta formal que aclare los puntos controvertidos y establezca una posici√≥n clara sobre los temas planteados.'
            };
            
            return responses[context] || 'Se requiere un an√°lisis m√°s detallado para proporcionar una respuesta espec√≠fica.';
        }

        // Inicializaci√≥n cuando se carga la p√°gina
        window.addEventListener('load', function() {
            showAlert('Sistema de an√°lisis de documentos legales iniciado correctamente', 'success');
        });
    </script>
</body>
</html>